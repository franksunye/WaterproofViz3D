<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å±‹é¡¶ç»´ä¿®ä¸‰ç»´æ¼”ç¤ºï¼ˆæ¦‚å¿µè¿­ä»£ï¼‰</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
    #uiContainer {
      position: absolute;
      top: 10px;
      left: 10px;
      z-index: 10;
    }
    button {
      padding: 6px 12px;
      margin: 4px;
      font-size: 14px;
    }
    #status {
      position: absolute;
      bottom: 20px;
      left: 20px; /* ä¿®æ”¹ä¸ºå±…å·¦ */
      background: rgba(255,255,255,0.9);
      padding: 8px 16px;
      font-size: 16px;
      max-width: 80%;
      border-radius: 8px;
      text-align: center;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      z-index: 20;
    }
    #resetView {
      position: absolute;
      bottom: 20px;
      right: 20px;
      z-index: 20;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: background-color 0.3s;
    }
    #resetView:hover {
      background-color: #45a049;
    }
  </style>
</head>
<body>
  <div id="uiContainer">
    <button id="removeWaterproof">1. ç§»é™¤æ—§é˜²æ°´</button>
    <button id="removeInsulation">2. æ‹†é™¤ä¿æ¸©å±‚</button>
    <button id="addNewWaterproof">3. é“ºè®¾æ–°é˜²æ°´</button>
    <button id="demoProcess">â–¶ï¸ æ¼”ç¤ºç»´ä¿®æµç¨‹</button>
  </div>
  <button id="resetView">ğŸ”„ é‡ç½®è§†å›¾</button>
  <div id="status">çŠ¶æ€æç¤ºå°†åœ¨è¿™é‡Œæ˜¾ç¤º</div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.157.0/build/three.module.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.157.0/examples/jsm/controls/OrbitControls.js?module';

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0xf0f0f0);

    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
    camera.position.set(6, 6, 10);

    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;

    scene.add(new THREE.AmbientLight(0xffffff, 0.4));
    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(10, 10, 10);
    scene.add(light);

    // ææ–™ - æå‰å®šä¹‰æ‰€æœ‰æè´¨
    const matBase = new THREE.MeshStandardMaterial({ color: 0x666666 });
    const matInsulation = new THREE.MeshStandardMaterial({ color: 0xffcc00, transparent: true, opacity: 0.8 });
    const matWaterproof = new THREE.MeshStandardMaterial({ color: 0x0066ff, transparent: true, opacity: 0.6 });
    const matNewWaterproof = new THREE.MeshStandardMaterial({ color: 0x00cc99, transparent: true, opacity: 0.8 });
    const matParapet = new THREE.MeshStandardMaterial({ color: 0x888888 });

    // åˆ›å»ºé«˜è´¨é‡Spriteæ–‡å­—æ ‡æ³¨
    function createLabel(text, size = 1.0, backgroundColor = 'rgba(255, 255, 255, 0.9)') {
      const canvas = document.createElement('canvas');
      const context = canvas.getContext('2d');
      
      // æ ¹æ®æ–‡æœ¬é•¿åº¦åŠ¨æ€è°ƒæ•´å­—ä½“å¤§å°
      let fontSize = 48;
      if (text.length > 3) fontSize = 36; // é•¿æ–‡æœ¬ä½¿ç”¨è¾ƒå°å­—ä½“
      if (text.length > 5) fontSize = 30; // æ›´é•¿æ–‡æœ¬è¿›ä¸€æ­¥å‡å°
      
      // è®¾ç½®å­—ä½“å¹¶æµ‹é‡æ–‡æœ¬å®½åº¦
      context.font = `bold ${fontSize}px Arial, sans-serif`;
      const textWidth = context.measureText(text).width;
      
      // è®¾ç½®canvaså°ºå¯¸ï¼Œå¢åŠ å®‰å…¨è¾¹è·
      canvas.width = textWidth * 1.2;
      canvas.height = fontSize * 1.8;
      
      // é‡æ–°è®¾ç½®å­—ä½“ï¼Œå› ä¸ºcanvaså°ºå¯¸å·²è°ƒæ•´
      context.font = `bold ${fontSize}px Arial, sans-serif`;
      context.textAlign = 'center';
      context.textBaseline = 'middle';
      
      // ç»˜åˆ¶èƒŒæ™¯
      context.fillStyle = backgroundColor;
      context.fillRect(0, 0, canvas.width, canvas.height);
      
      // æ·»åŠ è¾¹æ¡†
      context.strokeStyle = 'rgba(0, 0, 0, 0.3)';
      context.lineWidth = 2;
      context.strokeRect(0, 0, canvas.width, canvas.height);
      
      // ç»˜åˆ¶æ–‡å­—
      context.fillStyle = 'rgba(0, 0, 0, 0.9)';
      context.fillText(text, canvas.width / 2, canvas.height / 2);
      
      // åˆ›å»ºçº¹ç†
      const texture = new THREE.CanvasTexture(canvas);
      
      // åˆ›å»ºSpriteæè´¨
      const spriteMaterial = new THREE.SpriteMaterial({ 
        map: texture,
        transparent: true
      });
      
      // åˆ›å»ºSprite
      const sprite = new THREE.Sprite(spriteMaterial);
      sprite.scale.set(size, size * canvas.height / canvas.width, 1);
      sprite.userData = { originalSize: size }; // ä¿å­˜åŸå§‹å¤§å°ç”¨äºç¼©æ”¾åŠ¨ç”»
      
      return sprite;
    }

    // å±‚ç»“æ„ - ç¡®ä¿åœ¨ä½¿ç”¨æè´¨å‰å·²ç»å®šä¹‰
    const base = new THREE.Mesh(new THREE.BoxGeometry(6, 0.5, 6), matBase);
    base.position.y = 0;
    base.name = "ç»“æ„å±‚";
    scene.add(base);
    
    // æ·»åŠ ç»“æ„å±‚æ ‡æ³¨ï¼ˆæœ€å¤§ï¼Œä½ç½®æœ€å·¦ï¼‰
    const baseLabel = createLabel("ç»“æ„å±‚", 1.0);
    baseLabel.position.set(-2.5, 0.25, 3.5);
    scene.add(baseLabel);

    const insulation = new THREE.Mesh(new THREE.BoxGeometry(6, 0.3, 6), matInsulation);
    insulation.position.y = 0.5;
    insulation.name = "ä¿æ¸©å±‚";
    scene.add(insulation);
    
    // æ·»åŠ ä¿æ¸©å±‚æ ‡æ³¨ï¼ˆé€‚ä¸­ï¼Œä½ç½®å±…ä¸­ï¼‰
    const insulationLabel = createLabel("ä¿æ¸©å±‚", 0.9);
    insulationLabel.position.set(0, 0.8, 3.5);
    scene.add(insulationLabel);

    const waterproof = new THREE.Mesh(new THREE.BoxGeometry(6, 0.1, 6), matWaterproof);
    waterproof.position.y = 0.8;
    waterproof.name = "æ—§é˜²æ°´å±‚";
    scene.add(waterproof);
    
    // æ·»åŠ æ—§é˜²æ°´å±‚æ ‡æ³¨ï¼ˆè¾ƒå°ï¼Œä½ç½®åå³ï¼‰
    const waterproofLabel = createLabel("æ—§é˜²æ°´å±‚", 0.8);
    waterproofLabel.position.set(2.5, 0.95, 3.5);
    scene.add(waterproofLabel);

    const newWaterproof = new THREE.Mesh(new THREE.BoxGeometry(6, 0.1, 6), matNewWaterproof);
    newWaterproof.position.y = 0.8;
    newWaterproof.visible = false;
    newWaterproof.name = "æ–°é˜²æ°´å±‚";
    scene.add(newWaterproof);
    
    // æ·»åŠ æ–°é˜²æ°´å±‚æ ‡æ³¨ï¼ˆä¸æ—§é˜²æ°´å±‚å¯¹é½ï¼‰
    const newWaterproofLabel = createLabel("æ–°é˜²æ°´å±‚", 0.8);
    newWaterproofLabel.position.set(2.5, 0.95, 3.5);
    newWaterproofLabel.visible = false;
    scene.add(newWaterproofLabel);

    // æ·»åŠ å¥³å„¿å¢™ç»“æ„ï¼ˆè¾¹ç¼˜çš„ç°è‰²ç«–å¢™ï¼‰
    const parapet = new THREE.Mesh(new THREE.BoxGeometry(6, 1, 0.2), matParapet);
    parapet.position.set(0, 1.3, -3.1);
    parapet.name = "å¥³å„¿å¢™";
    scene.add(parapet);
    
    // æ·»åŠ å¥³å„¿å¢™æ ‡æ³¨ï¼ˆä½ç½®ç‹¬ç«‹ï¼‰
    const parapetLabel = createLabel("å¥³å„¿å¢™", 0.8, 'rgba(240, 240, 240, 0.9)');
    parapetLabel.position.set(0, 2.0, -3.1); // ç¡®ä¿æ ‡æ³¨åœ¨å¥³å„¿å¢™ä¸Šæ–¹
    scene.add(parapetLabel);

    // çŠ¶æ€æ›´æ–°
    const status = document.getElementById('status');
    function updateStatus(text) {
      status.innerText = `ğŸ“Œ å½“å‰çŠ¶æ€ï¼š${text}`;
      
      // æ·»åŠ çŠ¶æ€å˜åŒ–åŠ¨ç”»
      status.style.opacity = '0';
      setTimeout(() => {
        status.style.opacity = '1';
      }, 50);
    }

    // é«˜äº®æ ‡æ³¨ç‰Œ
    function highlightLabel(label, isHighlight = true) {
      const factor = isHighlight ? 1.2 : 1.0;
      label.scale.set(
        label.userData.originalSize * factor, 
        label.userData.originalSize * factor * label.material.map.image.height / label.material.map.image.width, 
        1
      );
    }

    // æŒ‰é’®äº¤äº’
    document.getElementById('removeWaterproof').onclick = () => {
      waterproof.visible = false;
      waterproofLabel.visible = false;
      updateStatus("å·²ç§»é™¤æ—§é˜²æ°´å±‚");
    };
    document.getElementById('removeInsulation').onclick = () => {
      insulation.visible = false;
      insulationLabel.visible = false;
      updateStatus("å·²æ‹†é™¤ä¿æ¸©å±‚");
    };
    document.getElementById('addNewWaterproof').onclick = () => {
      newWaterproof.visible = true;
      newWaterproofLabel.visible = true;
      updateStatus("å·²é“ºè®¾æ–°é˜²æ°´å±‚");
    };
    document.getElementById('resetView').onclick = () => {
        base.visible = true;
        insulation.visible = true;
        waterproof.visible = true;
        newWaterproof.visible = false;
        baseLabel.visible = true;
        insulationLabel.visible = true;
        waterproofLabel.visible = true;
        newWaterproofLabel.visible = false;
        updateStatus("å·²é‡ç½®è§†å›¾");
    };

    // æ¼”ç¤ºç»´ä¿®æµç¨‹
    document.getElementById('demoProcess').onclick = () => {
      // é‡ç½®çŠ¶æ€
      base.visible = true;
      insulation.visible = true;
      waterproof.visible = true;
      newWaterproof.visible = false;
      baseLabel.visible = true;
      insulationLabel.visible = true;
      waterproofLabel.visible = true;
      newWaterproofLabel.visible = false;
      updateStatus("å¼€å§‹æ¼”ç¤ºç»´ä¿®æµç¨‹...");

      // ä¾æ¬¡æ‰§è¡Œæ­¥éª¤
      setTimeout(() => {
        waterproof.visible = false;
        waterproofLabel.visible = false;
        updateStatus("å·²ç§»é™¤æ—§é˜²æ°´å±‚");
      }, 1500);

      setTimeout(() => {
        insulation.visible = false;
        insulationLabel.visible = false;
        updateStatus("å·²æ‹†é™¤ä¿æ¸©å±‚");
      }, 3000);

      setTimeout(() => {
        newWaterproof.visible = true;
        newWaterproofLabel.visible = true;
        updateStatus("å·²é“ºè®¾æ–°é˜²æ°´å±‚");
      }, 4500);
    };

    // æ ‡æ³¨äº¤äº’
    const raycaster = new THREE.Raycaster();
    const mouse = new THREE.Vector2();
    let currentHighlighted = null;
    
    window.addEventListener('mousemove', (event) => {
      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
      
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects([baseLabel, insulationLabel, waterproofLabel, newWaterproofLabel, parapetLabel]);
      
      // å–æ¶ˆä¹‹å‰çš„é«˜äº®
      if (currentHighlighted) {
        highlightLabel(currentHighlighted, false);
        currentHighlighted = null;
      }
      
      // é«˜äº®å½“å‰é€‰ä¸­çš„æ ‡æ³¨
      if (intersects.length > 0) {
        currentHighlighted = intersects[0].object;
        highlightLabel(currentHighlighted, true);
      }
    });

    // ç‚¹å‡»ç»“æ„å±‚æ˜¾ç¤ºè¯´æ˜
    window.addEventListener('click', (event) => {
      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
      mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
      
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects([base, insulation, waterproof, newWaterproof, parapet]);
      
      if (intersects.length > 0) {
        updateStatus(`ç‚¹å‡»äº†ï¼š${intersects[0].object.name}`);
      }
    });

    // åŠ¨ç”»æ¸²æŸ“
    function animate() {
      requestAnimationFrame(animate);
      controls.update();
      
      // ç¡®ä¿æ ‡æ³¨å§‹ç»ˆé¢å‘ç›¸æœº
      baseLabel.lookAt(camera.position);
      insulationLabel.lookAt(camera.position);
      waterproofLabel.lookAt(camera.position);
      newWaterproofLabel.lookAt(camera.position);
      parapetLabel.lookAt(camera.position);
      
      renderer.render(scene, camera);
    }
    animate();

    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>    